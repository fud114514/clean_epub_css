# EPUB CSS 清理工具 (EPUB CSS Cleaner)

这是一个简单的工具，用于移除 EPUB 电子书文件中嵌入的特定 CSS 样式规则。它提供两种版本：

1.  **Web 版本 (.html):** 在任何现代浏览器（电脑或手机）中打开即可使用，无需安装。**可以处理单个 EPUB 文件或包含多个 EPUB 的 ZIP 压缩包。**
2.  **Windows 可执行程序 (.exe):** 无需安装 Python，直接在 Windows 上运行，处理其所在文件夹内的所有 EPUB 文件（不支持处理 ZIP 压缩包）。

主要目的是帮助用户清理那些可能干扰阅读体验、导致排版混乱或与某些阅读器/设备不兼容的样式，例如强制的字体、行高、缩进或颜色等。

## 主要功能

*   **移除特定 CSS 样式：** 自动查找并移除以下 CSS 规则：
    *   `text-indent`
    *   `line-height`
    *   `font-size`
    *   `height`
    *   `font-family`
    *   `color`
    *   `display: block`
*   **跨平台兼容 (Web版):** HTML 版本可在 Windows, macOS, Linux, Android, iOS 等系统的现代浏览器上运行。
*   **ZIP 压缩包处理 (Web版):** Web 版本可以接受包含多个 EPUB 文件的 ZIP 压缩包，并批量处理其中的所有 EPUB 文件。
*   **Windows 专用 (.exe版):** 提供独立的 Windows 可执行文件，无需额外配置。
*   **无需安装 (Web版):** 直接在浏览器中打开 HTML 文件即可使用。
*   **本地处理 (Web版):** 文件处理完全在用户的浏览器中进行，不会上传到任何服务器，保护隐私。
*   **原地修改 (.exe版):** Windows 版本直接修改原始 EPUB 文件。**（请务必备份原文件！）**
*   **生成新文件 (Web版):**
    *   处理单个 EPUB 时，生成带 `_cleaned` 后缀的新 EPUB 文件。
    *   处理 ZIP 压缩包时，生成一个带 `_cleaned` 后缀的新 ZIP 文件，其中包含所有处理过的（或保持原样的）EPUB 文件。
*   **批量处理 (.exe版):** Windows 版本自动处理其所在文件夹内的所有 `.epub` 文件（不包括子文件夹）。
*   **批量处理 (Web版 - 通过 ZIP):** 通过上传包含多个 EPUB 的 ZIP 文件实现批量处理。

## 如何获取和使用

### 选项一：Web 版本 (推荐，跨平台，支持 ZIP)

**获取:**

1.  直接下载本仓库中的 `epub_cleaner.html` 文件。
2.  或者，如果你想将其托管在网上（例如使用 GitHub Pages），可以将该文件上传。

**使用方法:**

1.  用你的电脑或手机上的任何现代浏览器（如 Chrome, Firefox, Edge, Safari）打开 `epub_cleaner.html` 文件。
2.  你会看到一个简洁的界面。将你想要处理的 **单个 EPUB 文件** 或 **包含多个 EPUB 文件的 ZIP 压缩包** 拖拽到虚线框区域，或者点击“选择文件”按钮来选取文件。
3.  页面会显示处理进度。如果处理的是 ZIP 文件，还会显示在压缩包内找到和处理 EPUB 的简要信息。
4.  处理完成后：
    *   如果处理的是 **单个 EPUB 文件** 且 CSS 被修改，浏览器会自动提示你下载一个名为 `[原文件名]_cleaned.epub` 的新文件。
    *   如果处理的是 **ZIP 压缩包**，浏览器会自动提示你下载一个名为 `[原 ZIP 文件名]_cleaned.zip` 的新 ZIP 文件。这个新的 ZIP 文件里包含了所有被成功处理（修改过的会带 `_cleaned` 后缀）或无需修改（保持原名）的 EPUB 文件。处理失败的 EPUB 也会以原始状态包含在内（具体见日志）。
    *   如果文件没有找到需要移除的 CSS 样式，页面会提示“无需修改”，并且不会触发下载（对于单个 EPUB）或生成的文件中该 EPUB 会保持原样（对于 ZIP）。
5.  **重要提示:** Web 版本不会修改你的原始文件，它总是生成一个新的下载文件（单个 EPUB 或 ZIP 压缩包）。

### 选项二：Windows .exe 版本

**获取:**

1.  访问本仓库的 [Releases](https://github.com/你的用户名/你的仓库名/releases) 页面。 (你需要替换这里的链接为你实际的 GitHub Releases 页面链接)
2.  下载最新版本的 `clean_epub_css.exe` 文件。

**使用方法:**

1.  **极其重要：在运行此工具前，请务必备份你想要处理的 EPUB 文件！** 由于该工具直接修改原文件，如果处理过程中出现任何问题或你不满意结果，备份是恢复文件的唯一途径。
2.  将下载好的 `clean_epub_css.exe` 文件 **复制或移动** 到你存放 `.epub` 文件的文件夹中。
3.  **双击**运行 `clean_epub_css.exe` 文件。
4.  此时会弹出一个命令行窗口，工具会自动开始扫描并处理该文件夹下的所有 `.epub` 文件。
    *   你会看到类似以下的输出信息：
        ```
        将在脚本所在目录 'C:\Users\YourUser\Desktop\MyEpubs' 中查找并原地修改 EPUB 文件...
        将移除以下 CSS 样式: text-indent, line-height, font-size, height, font-family, color, display:block
        警告: 操作将直接修改原文件！建议提前备份。
        --------------------
        开始处理 (原地修改): example1.epub
          已清理: Styles/style.css
          正在重新打包修改后的内容...
          正在替换原文件...
        处理完成 (原地修改): example1.epub
        开始处理 (原地修改): another_book.epub
          信息: 在 another_book.epub 中未找到 CSS 文件。
        --------------------

        --- 任务完成 ---
        已尝试处理文件数: 2
        处理成功（包含未修改）文件数: 2
        处理失败文件数: 0

        按 Enter 键退出...
        ```
5.  处理完成后，命令行窗口会显示“按 Enter 键退出...”，此时按回车键即可关闭窗口。你的 EPUB 文件已经被修改。

## 注意事项

**通用:**

*   **效果并非万能：** EPUB 结构复杂多样，此工具不保证对所有 EPUB 文件都完美有效。某些样式可能嵌入在 HTML 标签的 `style` 属性中，本工具不会处理这种情况。
*   **编码问题：** 工具默认尝试使用 `UTF-8` 编码处理 CSS 文件。对于使用其他罕见编码的 CSS 文件，可能无法正确处理或导致乱码 (Web 版会尝试保留原文件，.exe 版可能跳过)。

**Web 版本特定:**

*   **浏览器性能：** 处理非常大的 EPUB 文件或包含大量 EPUB 的大型 ZIP 文件可能会消耗较多内存和 CPU，在性能较差的设备（尤其是旧手机）上可能会变慢、卡顿甚至因内存不足而失败。
*   **库加载：** 需要稳定的网络连接才能加载所需的 JavaScript 库 (JSZip, FileSaver) 来运行。如果加载失败，页面会提示错误。广告拦截器或网络限制可能阻止库加载。
*   **ZIP 内文件处理：** Web 版本会处理 ZIP 压缩包**根目录**下的 EPUB 文件。目前**不会**处理 ZIP 压缩包内子文件夹中的 EPUB 文件，也不会将 ZIP 中的非 EPUB 文件添加到输出的 ZIP 中。处理失败的 EPUB 文件会以原始状态包含在输出 ZIP 中。

**Windows .exe 版本特定:**

*   **备份！备份！备份！** 再次强调，.exe 版本会直接修改原文件，请务必备份。
*   **仅限 Windows:** 此 `.exe` 文件仅适用于 Windows 操作系统。
*   **当前目录：** .exe 工具只处理其所在的当前文件夹，不会处理子文件夹。
*   **不支持 ZIP：** .exe 版本不能处理 ZIP 压缩包。
*   **杀毒软件误报：** 某些杀毒软件可能会将 `.exe` 文件（尤其是使用 PyInstaller 单文件打包的）标记为潜在威胁。这通常是误报。如果你信任此工具的来源，可以将文件添加到杀毒软件的信任列表。

## 工作原理简述

*   **Web 版本:**
    1.  使用 HTML 构建用户界面。
    2.  通过 JavaScript 监听文件选择或拖拽事件，接受 `.epub` 或 `.zip` 文件。
    3.  使用 FileReader API 读取文件内容。
    4.  **如果输入是 ZIP 文件:**
        *   使用 JSZip 打开输入的 ZIP 文件。
        *   遍历 ZIP 内的文件，查找 `.epub` 文件。
        *   对于每个找到的 `.epub` 文件，提取其内容（作为 ArrayBuffer）。
        *   调用内部的 EPUB 处理逻辑（见下一步）。
        *   将处理结果（修改后的 EPUB Blob 或原始 ArrayBuffer）添加到 **新的输出 ZIP** 实例中。
        *   生成这个新的输出 ZIP 文件并触发下载。
    5.  **如果输入是单个 EPUB 文件 (或作为 ZIP 内文件处理):**
        *   利用 JSZip 库在浏览器中解压 EPUB 文件内容。
        *   遍历解压后的文件，处理 CSS 文件（移除指定样式），其他文件保持不变。
        *   使用 JSZip 将处理后的文件重新打包成一个新的 EPUB (Blob 对象)。
        *   (对于单个 EPUB 上传) 利用 FileSaver.js 库触发浏览器下载这个新生成的 EPUB 文件。
        *   (对于 ZIP 内文件) 将生成的 EPUB Blob 返回给 ZIP 处理逻辑。
    6.  整个过程在用户浏览器本地完成，不依赖服务器。

*   **.exe 版本:**
    1.  该 `.exe` 文件是使用 [PyInstaller](https://www.pyinstaller.org/) 将一个 Python 脚本打包而成的。
    2.  获取 `.exe` 文件所在的目录。
    3.  遍历该目录下的所有 `.epub` 文件。
    4.  对于每个 `.epub` 文件：
        *   使用 Python 的 `zipfile` 模块将其解压到一个临时文件夹。
        *   遍历解压后的文件，找到所有 `.css` 文件。
        *   读取 `.css` 文件内容。
        *   使用 Python 的 `re` 模块（正则表达式）查找并移除预设的 CSS 样式规则。
        *   如果内容有修改，则将修改后的内容写回 `.css` 文件。
        *   使用 `zipfile` 模块将临时文件夹中的所有内容重新打包成一个新的临时 EPUB 文件。
        *   用这个新的临时 EPUB 文件覆盖原始的 EPUB 文件。
        *   清理临时文件和目录。

## 许可证 (License)

本项目采用 [MIT License](LICENSE) 授权。（如果你的仓库还没有 LICENSE 文件，可以创建一个，或者选择其他你喜欢的开源许可证，并更新这里的链接）
