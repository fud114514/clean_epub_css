# EPUB CSS 清理工具 (EPUB CSS Cleaner)

这是一个简单的工具，用于移除 EPUB 电子书文件中嵌入的特定 CSS 样式规则。它提供两种版本：

1.  **Windows 可执行程序 (.exe):** 无需安装 Python，直接在 Windows 上运行，处理其所在文件夹内的 EPUB 文件。
2.  **Web 版本 (.html):** 在任何现代浏览器（电脑或手机）中打开即可使用，无需安装，处理过程完全在浏览器本地进行。

主要目的是帮助用户清理那些可能干扰阅读体验、导致排版混乱或与某些阅读器/设备不兼容的样式，例如强制的字体、行高、缩进或颜色等。

## 主要功能

*   **移除特定 CSS 样式：** 自动查找并移除以下 CSS 规则：
    *   `text-indent`
    *   `line-height`
    *   `font-size`
    *   `height`
    *   `font-family`
    *   `color`
    *   `display: block`
*   **跨平台兼容 (Web版):** HTML 版本可在 Windows, macOS, Linux, Android, iOS 等系统的现代浏览器上运行。
*   **Windows 专用 (.exe版):** 提供独立的 Windows 可执行文件，无需额外配置。
*   **无需安装 (Web版):** 直接在浏览器中打开 HTML 文件即可使用。
*   **本地处理 (Web版):** 文件处理完全在用户的浏览器中进行，不会上传到任何服务器，保护隐私。
*   **原地修改 (.exe版):** Windows 版本直接修改原始 EPUB 文件。**（请务必备份原文件！）**
*   **生成新文件 (Web版):** Web 版本会生成一个带 `_cleaned` 后缀的新 EPUB 文件供用户下载，不修改原始文件。
*   **批量处理 (.exe版):** Windows 版本自动处理其所在文件夹内的所有 `.epub` 文件（不包括子文件夹）。
*   **单文件处理 (Web版):** Web 版本一次处理一个用户选择或拖拽的 EPUB 文件。

## 如何获取和使用

### 选项一：Web 版本 (推荐，跨平台)

**获取:**

1.  直接下载本仓库中的 `epub_cleaner.html` 文件。
2.  或者，如果你想将其托管在网上（例如使用 GitHub Pages），可以将该文件上传。

**使用方法:**

1.  用你的电脑或手机上的任何现代浏览器（如 Chrome, Firefox, Edge, Safari）打开 `epub_cleaner.html` 文件。
2.  你会看到一个简洁的界面。将你想要处理的单个 EPUB 文件拖拽到虚线框区域，或者点击“选择文件”按钮来选取文件。
3.  页面会显示处理进度。
4.  如果处理成功且 CSS 文件被修改，浏览器会自动提示你下载一个名为 `[原文件名]_cleaned.epub` 的新文件。请保存这个文件。
5.  如果文件没有找到需要移除的 CSS 样式，页面会提示“无需修改”，并且不会触发下载。
6.  **重要提示:** Web 版本不会修改你的原始文件，它总是生成一个新的下载文件。

### 选项二：Windows .exe 版本

**获取:**

1.  访问本仓库的 [Releases](https://github.com/你的用户名/你的仓库名/releases) 页面。 (你需要替换这里的链接为你实际的 GitHub Releases 页面链接)
2.  下载最新版本的 `clean_epub_css.exe` 文件。

**使用方法:**

1.  **极其重要：在运行此工具前，请务必备份你想要处理的 EPUB 文件！** 由于该工具直接修改原文件，如果处理过程中出现任何问题或你不满意结果，备份是恢复文件的唯一途径。
2.  将下载好的 `clean_epub_css.exe` 文件 **复制或移动** 到你存放 `.epub` 文件的文件夹中。
3.  **双击**运行 `clean_epub_css.exe` 文件。
4.  此时会弹出一个命令行窗口，工具会自动开始扫描并处理该文件夹下的所有 `.epub` 文件。
    *   你会看到类似以下的输出信息：
        ```
        将在脚本所在目录 'C:\Users\YourUser\Desktop\MyEpubs' 中查找并原地修改 EPUB 文件...
        将移除以下 CSS 样式: text-indent, line-height, font-size, height, font-family, color, display:block
        警告: 操作将直接修改原文件！建议提前备份。
        --------------------
        开始处理 (原地修改): example1.epub
          已清理: Styles/style.css
          正在重新打包修改后的内容...
          正在替换原文件...
        处理完成 (原地修改): example1.epub
        开始处理 (原地修改): another_book.epub
          信息: 在 another_book.epub 中未找到 CSS 文件。
        --------------------

        --- 任务完成 ---
        已尝试处理文件数: 2
        处理成功（包含未修改）文件数: 2
        处理失败文件数: 0

        按 Enter 键退出...
        ```
5.  处理完成后，命令行窗口会显示“按 Enter 键退出...”，此时按回车键即可关闭窗口。你的 EPUB 文件已经被修改。

## 注意事项

**通用:**

*   **效果并非万能：** EPUB 结构复杂多样，此工具不保证对所有 EPUB 文件都完美有效。某些样式可能嵌入在 HTML 标签的 `style` 属性中，本工具不会处理这种情况。
*   **编码问题：** 工具默认尝试使用 `UTF-8` 编码处理 CSS 文件。对于使用其他罕见编码的 CSS 文件，可能无法正确处理或导致乱码 (Web 版会尝试保留原文件，.exe 版可能跳过)。

**Web 版本特定:**

*   **浏览器性能：** 处理非常大的 EPUB 文件可能会消耗较多内存和 CPU，在性能较差的设备（尤其是旧手机）上可能会变慢或卡顿甚至失败。
*   **库加载：** 需要稳定的网络连接才能加载所需的 JavaScript 库 (JSZip, FileSaver) 来运行。如果加载失败，页面会提示错误。广告拦截器或网络限制可能阻止库加载。
*   **无批量处理:** Web 版本一次只能处理一个文件。

**Windows .exe 版本特定:**

*   **备份！备份！备份！** 再次强调，.exe 版本会直接修改原文件，请务必备份。
*   **仅限 Windows:** 此 `.exe` 文件仅适用于 Windows 操作系统。
*   **当前目录：** .exe 工具只处理其所在的当前文件夹，不会处理子文件夹。
*   **杀毒软件误报：** 某些杀毒软件可能会将 `.exe` 文件（尤其是使用 PyInstaller 单文件打包的）标记为潜在威胁。这通常是误报。如果你信任此工具的来源，可以将文件添加到杀毒软件的信任列表。

## 工作原理简述

*   **Web 版本:**
    1.  使用 HTML 构建用户界面。
    2.  通过 JavaScript 监听文件选择或拖拽事件。
    3.  使用 [FileReader API](https://developer.mozilla.org/en-US/docs/Web/API/FileReader) 读取用户选择的 EPUB 文件内容到浏览器内存中。
    4.  利用 [JSZip](https://stuk.github.io/jszip/) 库在浏览器中解压 EPUB 文件内容。
    5.  遍历解压后的文件：
        *   如果是 CSS 文件，读取其文本内容。
        *   使用 JavaScript 正则表达式查找并移除预设的 CSS 规则。
        *   将修改后（或原始）的内容添加到新的 JSZip 实例中。
        *   非 CSS 文件直接将其原始数据添加到新的 JSZip 实例中，注意保持 `mimetype` 文件未压缩。
    6.  使用 JSZip 将处理后的文件重新打包成一个新的 EPUB (Blob 对象)。
    7.  利用 [FileSaver.js](https://github.com/eligrey/FileSaver.js/) 库触发浏览器下载这个新生成的 EPUB 文件。
    8.  整个过程在用户浏览器本地完成，不依赖服务器。

*   **.exe 版本:**
    1.  该 `.exe` 文件是使用 [PyInstaller](https://www.pyinstaller.org/) 将一个 Python 脚本打包而成的。
    2.  获取 `.exe` 文件所在的目录。
    3.  遍历该目录下的所有 `.epub` 文件。
    4.  对于每个 `.epub` 文件：
        *   使用 Python 的 `zipfile` 模块将其解压到一个临时文件夹。
        *   遍历解压后的文件，找到所有 `.css` 文件。
        *   读取 `.css` 文件内容。
        *   使用 Python 的 `re` 模块（正则表达式）查找并移除预设的 CSS 样式规则。
        *   如果内容有修改，则将修改后的内容写回 `.css` 文件。
        *   使用 `zipfile` 模块将临时文件夹中的所有内容重新打包成一个新的临时 EPUB 文件。
        *   用这个新的临时 EPUB 文件覆盖原始的 EPUB 文件。
        *   清理临时文件和目录。

## 许可证 (License)

本项目采用 [MIT License](LICENSE) 授权。（如果你的仓库还没有 LICENSE 文件，可以创建一个，或者选择其他你喜欢的开源许可证，并更新这里的链接）
